name: Sync Tokens from K1.juce

permissions:
  contents: read
  pages: write
  id-token: write

on:
  repository_dispatch:
    types: [k1_tokens_updated]
  workflow_dispatch:

jobs:
  sync_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout site
        uses: actions/checkout@v4

      - name: Checkout K1.juce (public)
        run: |
          git clone --depth=1 https://github.com/synqing/K1.juce K1.juce

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Debug K1.juce tokens tree
        working-directory: K1.juce
        run: |
          set -euxo pipefail
          python3 -V
          ls -la
          ls -la tools/tokens || true
          ls -la tokens || true
          ls -la tokens/src || true
          test -f tokens/src/dark.json || (echo 'dark.json missing' && exit 1)

      - name: Export CSS/TW from K1.juce tokens
        working-directory: K1.juce
        run: |
          python3 tools/tokens/export_css.py --src tokens/src/dark.json --out tokens/build/web

      - name: Copy tokens into site
        run: |
          rm -rf tokens-web
          mkdir -p tokens-web/css
          cp -R K1.juce/tokens/build/web/css/* tokens-web/css/
          cp K1.juce/tokens/build/web/tailwind.config.ts tokens-web/tailwind.config.ts
          cp K1.juce/tokens/build/web/shadcn-theme.css tokens-web/shadcn-theme.css
          ls -la tokens-web
      - name: Create Tailwind JS preset shim
        run: |
          cat > tokens-web/tailwind-preset.cjs <<'JS'
          module.exports = {
            theme: {
              extend: {
                colors: {
                  primary: 'var(--color-brand-primary)',
                  background: 'var(--color-bg-surface)',
                  foreground: 'var(--color-fg-primary)'
                },
                borderRadius: { md: 'var(--radius-base)' }
              }
            }
          }
          JS

      - name: Create static tokens demo (public/index.html)
        run: |
          mkdir -p public
          cat > public/index.html <<'HTML'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>K1 Tokens Demo</title>
            <link rel="stylesheet" href="tokens-web/css/variables.css" />
            <link rel="stylesheet" href="tokens-web/shadcn-theme.css" />
            <style>
              :root { font-family: -apple-system, system-ui, Segoe UI, Inter, sans-serif; }
              body { background: var(--color-bg-surface); color: var(--color-fg-primary); margin: 0; padding: 24px; }
              .card { background: var(--color-bg-surface-elevated); border: 1px solid var(--color-border-subtle);
                      border-radius: var(--radius-base); padding: 16px; max-width: 720px; }
              .btn  { display:inline-block; background: var(--color-brand-primary); color: var(--color-fg-primary);
                      border-radius: var(--radius-base); padding: 8px 12px; text-decoration:none; margin-top: 8px; }
              .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap: 12px; margin-top:16px; }
              .sw  { border-radius: var(--radius-sm); border: 1px solid var(--color-border-subtle); height: 48px; }
              code { background: rgba(255,255,255,0.08); padding: 2px 4px; border-radius: 4px; }
            </style>
          </head>
          <body>
            <div class="card">
              <h1>K1 Tokens Demo</h1>
              <p>CSS variables exported from K1.juce â†’ <code>tokens-web/</code></p>
              <a class="btn" href="#">Primary</a>
              <div class="grid">
                <div class="sw" style="background:var(--color-bg-app)"></div>
                <div class="sw" style="background:var(--color-bg-surface)"></div>
                <div class="sw" style="background:var(--color-brand-primary)"></div>
                <div class="sw" style="background:var(--color-status-success)"></div>
              </div>
            </div>
          </body>
          </html>
          HTML
          cp -R tokens-web public/tokens-web

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps (if site exists)
        run: |
          if [ -f package.json ]; then             if [ -f package-lock.json ]; then npm ci;             elif [ -f pnpm-lock.yaml ]; then corepack enable && pnpm i --frozen-lockfile;             elif [ -f yarn.lock ]; then corepack enable && yarn install --frozen-lockfile;             else npm install; fi;           else echo "No package.json, skipping install"; fi

      - name: Build site (if script exists)
        run: |
          if [ -f package.json ]; then             if npm run | grep -q "build"; then npm run build; else echo "No build script"; fi;           else echo "No package.json, skipping build"; fi

      - name: Upload build artifact (debug)
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: |
            public
            .next
            dist
            out
          if-no-files-found: ignore

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact (Next out)
        uses: actions/upload-pages-artifact@v3
        with:
          path: out

  deploy:
    needs: sync_and_build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
